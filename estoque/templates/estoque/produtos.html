<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Produtos - {{ setor }}</title>
<style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI', Arial, sans-serif; line-height:1.6; background:#f8f9fa; color:#333; }

    /* Navbar branco e links neutros */
    .navbar {
        position: fixed; top:0; left:0; width:100%;
        background:#fff; color:#000; padding:12px 20px;
        box-shadow:0 2px 15px rgba(0,0,0,0.1);
        display:flex; justify-content:space-between; align-items:center; z-index:1000;
    }
    .navbar-logo { height:42px; width:auto; }
    .navbar-links { display:flex; align-items:center; gap:20px; }
    .navbar-links span { font-size:0.95rem; opacity:0.9; }
    .navbar-links a { color:#000; text-decoration:none; padding:8px 16px; border-radius:4px; background:rgba(255,0,0,0.1); transition:all 0.3s ease; }
    .navbar-links a:hover { background:rgba(251,0,0,0.2); transform:translateY(-1px); }
    .menu-toggle { display:none; background:none; border:none; font-size:1.5rem; cursor:pointer; color:#000; }
    .sidebar {
        position: fixed; top:60px; left:0; width:260px; height:calc(100vh - 60px);
        background:#fff; padding:25px 0; box-shadow:2px 0 15px rgba(0,0,0,0.05);
        overflow-y:auto; transition:all 0.3s ease; z-index:999;
    }
    .sidebar a {
        display:flex; align-items:center; color:#555; padding:12px 25px;
        text-decoration:none; transition:all 0.3s ease; border-left:3px solid transparent; margin:5px 0;
    }
    .sidebar a:hover { background:#f8f9fa; color:#2c3e50;border-left-color: #ea005f; transform:translateX(5px); }
    .sidebar a strong { font-weight:600; }

    /* Conteúdo principal */
    .content { margin-top:60px; margin-left:260px; padding:30px; min-height:calc(100vh - 60px); }
    .page-header {
        background:white; padding:25px 30px; border-radius:10px;
        box-shadow:0 5px 15px rgba(0,0,0,0.08); margin-bottom:30px;
        border-left:4px solid #3498db;
    }
    .page-header h1 { color:#2c3e50; margin-bottom:10px; font-size:1.8rem; }
    .back-link { color:#3498db; text-decoration:none; display:inline-flex; align-items:center; gap:5px; transition:all 0.3s ease; }
    .back-link:hover { color:#2980b9; transform:translateX(-3px); }

    /* Tabela de produtos estilo card */
    .table-container {
        background:white; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.08); overflow:hidden;
    }
    .products-table { width:100%; border-collapse:collapse; font-size:0.95rem; }
    .products-table th { background:#000000; padding:15px 12px; text-align:left; font-weight:600; color:#ffffff; border-bottom:2px solid #e2e8f0; }
    .products-table td { padding:15px 12px; border-bottom:1px solid #e2e8f0; transition:background-color 0.2s ease; }
    .products-table tr:hover td { background-color:#f8fafc; }
    .products-table tr:last-child td { border-bottom:none; }

    /* Botões de ação azul */
    .action-btn {
        background:#ea005f; color:white; border:none; padding:8px 15px; border-radius:5px;
        cursor:pointer; font-size:0.9rem; transition:all 0.3s ease;
    }
    .action-btn:hover { background:#ae0548; transform:translateY(-2px); }

    /* Modal coerente */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); }
    .modal-content {
        background:#fff; margin:10% auto; padding:0; width:90%; max-width:450px; border-radius:10px;
        box-shadow:0 10px 30px rgba(0,0,0,0.2); overflow:hidden;
    }
    .modal-header { background:#000000; color:#fff; padding:20px; display:flex; justify-content:space-between; align-items:center; }
    .modal-header h3 { margin:0; font-weight:500; }
    .close { color:white; font-size:24px; font-weight:bold; cursor:pointer; }
    .modal-body { padding:25px; }
    .form-control { width:100%; padding:12px 15px; border:1px solid #ddd; border-radius:5px; font-size:1rem; margin-bottom:15px; }
    .submit-btn { background:#ea005f; color:white; border:none; padding:12px 20px; border-radius:5px; cursor:pointer; font-size:1rem; width:100%; transition:all 0.3s ease; }
    .submit-btn:hover { background:#ab0648; transform:translateY(-2px); }
    .error-message { color:#e74c3c; margin-top:10px; text-align:center; }

    /* Responsividade */
    @media(max-width:768px){
        .navbar { padding:10px 15px; }
        .navbar h1 { font-size:1.2rem; }
        .sidebar { width:280px; transform:translateX(-100%); }
        .sidebar.mobile-open { transform:translateX(0); }
        .content { margin-left:0; padding:20px 15px; }
        .menu-toggle { display:block; }
    }
    @media(min-width:769px){ .menu-toggle { display:none; } }
</style>
</head>
<body>

<!-- Navbar -->
<div class="navbar">
    <img src="https://faculdadelibano.edu.br/_next/image?url=%2Froot%2Flogo-website-colorida.webp&w=384&q=75" alt="Faculdade Libano" class="navbar-logo">
    <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
    <div class="navbar-links">
        <span>{{ request.user.username }} {% if not is_admin %} – {{ request.user.groups.first.name }} {% else %} – Admin {% endif %}</span>
        <a href="{% url 'logout' %}">Sair</a>
    </div>
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <a href="{% url 'index' %}">Inicio</a>
    {% if is_admin %}
        <a href="{% url 'produtos_setor' 'todos' %}">Estoque Total</a>
    {% else %}
        {% for setor in hub_info %}
            <a href="{% url 'produtos_setor' setor.nome_setor %}">Estoque <strong>{{ setor.nome_setor }}</strong></a>
        {% endfor %}
    {% endif %}
    <a href="{% url 'adicionar_produto' %}">Adicionar Produto</a>
    {% if is_admin %}
        <a href="{% url 'adicionar_usuario' %}">Adicionar Usuário</a>
        <a href="{% url 'gerenciar_usuarios' %}">Gerenciar Usuários</a>
        <a href="{% url 'movimentacoes' %}">Ver Movimentações</a>
        <a href="{% url 'dashboard_graficos' %}">Dashboard de Gráficos</a>
    {% endif %}
</div>

<!-- Conteúdo principal -->
<div class="content">
    <h1>Estoque do Setor - {{ setor }}</h1>
    <div style="margin-bottom:20px; display:flex; gap:15px; align-items:center;">
    <input type="text" id="searchInput" placeholder="Pesquisar produto..." class="form-control" style="flex:1;">
    
<select id="setorFilter" class="form-control" style="max-width:200px;">
    <option value="">Todos os Setores</option>
    {% for setor in setores %}
        <option value="{{ setor.name }}">{{ setor.name }}</option>
    {% endfor %}
</select>
</div>
    <div class="table-container">
        <table class="products-table">
<thead>
    <tr>
        <th>Nome</th>
        <th>Quantidade</th>
        <th>Setor</th> <!-- NOVO -->
        <th>Observações</th>
        <th>Ações</th>
    </tr>
</thead>
<tbody>
    {% for produto in produtos %}
    <tr>
        <td>{{ produto.nome }}</td>
        <td id="quantidade-{{ produto.id }}">{{ produto.quantidade }}</td>
        <td>{{ produto.setor_responsavel.name }}</td> <!-- NOVO -->
        <td>{{ produto.observacoes }}</td>
        <td>
            <button class="action-btn" onclick="abrirModal({{ produto.id }}, '{{ produto.nome }}')">Retirar</button>
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="5" style="text-align:center; padding:40px; color:#666;">
            Nenhum produto encontrado neste setor
        </td>
    </tr>
    {% endfor %}
</tbody>

        </table>
    </div>
</div>

<!-- Modal -->
<div id="modalRetirar" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="tituloModal">Retirar item</h3>
            <span class="close" onclick="fecharModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="formRetirar">
                <input type="number" name="quantidade" min="1" placeholder="Quantidade" class="form-control">
                <button type="submit" class="submit-btn">Confirmar</button>
            </form>
            <p id="erro" class="error-message"></p>
        </div>
    </div>
</div>

<script>
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('mobile-open'); }
document.addEventListener('click', function(event){
    const sidebar=document.getElementById('sidebar'); const menuToggle=document.querySelector('.menu-toggle');
    if(window.innerWidth<=768 && !sidebar.contains(event.target) && !menuToggle.contains(event.target)){
        sidebar.classList.remove('mobile-open');
    }
});

let produtoIdAtual=null;
function abrirModal(id,nome){ produtoIdAtual=id; document.getElementById('tituloModal').innerText='Retirar: '+nome; document.getElementById('erro').innerText=''; document.getElementById('modalRetirar').style.display='block'; }
function fecharModal(){ document.getElementById('modalRetirar').style.display='none'; }

document.getElementById('formRetirar').addEventListener('submit', function(e){
    e.preventDefault();
    const formData=new FormData(this);
    fetch(`/retirar_item/${produtoIdAtual}/`, {
        method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}, body:formData
    }).then(r=>r.json()).then(data=>{
        if(data.success){ document.getElementById('quantidade-'+produtoIdAtual).innerText=data.nova_quantidade; fecharModal(); }
        else{ document.getElementById('erro').innerText=data.error; }
    }).catch(()=>{ document.getElementById('erro').innerText='Erro ao retirar.'; });
});

window.onclick=function(event){ if(event.target===document.getElementById('modalRetirar')){ fecharModal(); } }
const searchInput = document.getElementById('searchInput');
const setorFilter = document.getElementById('setorFilter');
const tableRows = document.querySelectorAll('.products-table tbody tr');

function filtrarTabela(){
    const searchTerm = searchInput.value.toLowerCase();
    const setorSelecionado = setorFilter.value;

    tableRows.forEach(row => {
        const nome = row.cells[0]?.innerText.toLowerCase();
        const setor = row.cells[2]?.innerText;

        const matchNome = nome.includes(searchTerm);
        const matchSetor = setorSelecionado === "" || setor === setorSelecionado;

        if(matchNome && matchSetor){
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
}

searchInput.addEventListener('keyup', filtrarTabela);
setorFilter.addEventListener('change', filtrarTabela);
</script>

</body>
</html>
